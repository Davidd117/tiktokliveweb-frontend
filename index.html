<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TikTok Live R/Place</title>
<style>
  body { background:#111; color:white; text-align:center; font-family:Arial; }
  #canvasContainer { width: 800px; height: 800px; margin: 20px auto; border: 2px solid #444; background: #222; overflow: hidden; cursor: grab; }
  canvas { width:100%; height:100%; display:block; }
  input, button { padding:5px; margin:5px; }
  #userInfo { margin-top: 10px; }
  #adminPanel { display:none; background:#222; padding:10px; border:1px solid #555; margin:10px auto; width:300px; }
  
  /* Color Palette */
  #palette-panel { display:none; background:#222; padding:10px; border:1px solid #555; margin:15px auto; width:340px; text-align:center; }
  .colors { display:flex; gap:5px; justify-content:center; flex-wrap:wrap; }
  .color { width:30px; height:30px; cursor:pointer; border-radius:4px; border:2px solid transparent; }
  .color.selected { border:2px solid #fff; }

  /* Hover Panel */
  #hoverInfo {
    display:none;
    position:absolute;
    width:140px;
    background:#222;
    border:1px solid #555;
    padding:10px;
    border-radius:6px;
    text-align:center;
    box-shadow:0 4px 10px rgba(0,0,0,0.6);
    z-index:1000;
    pointer-events:none;
  }
  #hoverInfo img {
    width:64px;
    height:64px;
    border-radius:50%;
    object-fit:cover;
    border:2px solid #4ce0ff;
    display:block;
    margin:0 auto 6px auto;
  }
  #hoverInfo div {
    font-size:14px;
    word-break: break-word;
  }
</style>
</head>
<body>
<h2>TikTok Live R/Place</h2>

<div>
  <button id="getTokenBtn">Generate Verification Token</button>
</div>
<div>
  <label>Verification Token (copy to TikTok chat):</label>
  <input type="text" id="verificationToken" readonly style="width:300px;">
</div>
<div>
  <label>Return Token (save this for login):</label>
  <input type="text" id="returnToken" readonly style="width:300px;">
</div>
<div>
  <input type="text" id="usernameInput" placeholder="TikTok Username">
  <input type="text" id="returnCodeInput" placeholder="Return Token">
  <button id="returnLoginBtn">Return Login</button>
</div>

<div id="status">Not verified</div>
<div id="userInfo"></div>

<div id="palette-panel">
  <h3>ðŸŽ¨ Color Palette</h3>
  <div class="colors" id="colorPalette">
    <!-- Your colors -->
    <div class="color selected" data-color="#6d001a" style="background:#6d001a;"></div>
    <div class="color" data-color="#be0039" style="background:#be0039;"></div>
    <div class="color" data-color="#ff4500" style="background:#ff4500;"></div>
    <div class="color" data-color="#ffa800" style="background:#ffa800;"></div>
    <div class="color" data-color="#ffd635" style="background:#ffd635;"></div>
    <div class="color" data-color="#fff8b8" style="background:#fff8b8;"></div>
    <div class="color" data-color="#00a368" style="background:#00a368;"></div>
    <div class="color" data-color="#00cc78" style="background:#00cc78;"></div>
    <div class="color" data-color="#7eed56" style="background:#7eed56;"></div>
    <div class="color" data-color="#00756f" style="background:#00756f;"></div>
    <div class="color" data-color="#009eaa" style="background:#009eaa;"></div>
    <div class="color" data-color="#00ccc0" style="background:#00ccc0;"></div>
    <div class="color" data-color="#2450a4" style="background:#2450a4;"></div>
    <div class="color" data-color="#3690ea" style="background:#3690ea;"></div>
    <div class="color" data-color="#51e9f4" style="background:#51e9f4;"></div>
    <div class="color" data-color="#493ac1" style="background:#493ac1;"></div>
    <div class="color" data-color="#6a5cff" style="background:#6a5cff;"></div>
    <div class="color" data-color="#94b3ff" style="background:#94b3ff;"></div>
    <div class="color" data-color="#811e9f" style="background:#811e9f;"></div>
    <div class="color" data-color="#b44ac0" style="background:#b44ac0;"></div>
    <div class="color" data-color="#e4abff" style="background:#e4abff;"></div>
    <div class="color" data-color="#de107f" style="background:#de107f;"></div>
    <div class="color" data-color="#ff3881" style="background:#ff3881;"></div>
    <div class="color" data-color="#ff99aa" style="background:#ff99aa;"></div>
    <div class="color" data-color="#6d482f" style="background:#6d482f;"></div>
    <div class="color" data-color="#9c6926" style="background:#9c6926;"></div>
    <div class="color" data-color="#ffb470" style="background:#ffb470;"></div>
    <div class="color" data-color="#000000" style="background:#000000;"></div>
    <div class="color" data-color="#515252" style="background:#515252;"></div>
    <div class="color" data-color="#898d90" style="background:#898d90;"></div>
    <div class="color" data-color="#d4d7d9" style="background:#d4d7d9;"></div>
    <div class="color" data-color="#ffffff" style="background:#ffffff; border:1px solid #ccc;"></div>
    <!-- PFP option -->
    <div class="color" id="pfpOption" data-color="pfp" style="background:linear-gradient(45deg,#4ce0ff,#ff4500); border:2px dashed #fff;" title="Place your TikTok PFP"></div>
  </div>
</div>

<div id="canvasContainer">
  <canvas id="canvas"></canvas>
</div>

<div>
  <button id="adminLoginBtn">Admin Login</button>
</div>
<div id="adminPanel">
  <input type="text" id="adminKeyInput" placeholder="Admin Key">
  <button id="adminVerifyBtn">Verify Admin</button>
  <div id="adminControls" style="display:none;">
    <input type="text" id="adminUsername" placeholder="Username">
    <button id="clearUserPixelsBtn">Clear User Pixels</button>
    <button id="unverifyUserBtn">Unverify User</button>
    <button id="clearAllBtn">Clear All Pixels</button>
  </div>
</div>

<!-- Hover Panel -->
<div id="hoverInfo">
  <img id="hoverPfp" src="" alt="pfp">
  <div id="hoverName"></div>
</div>

<script>
const currentSession = 'session_' + Math.random().toString(36).substring(2, 10);
const ws = new WebSocket("wss://tiktokliveweb-production.up.railway.app");

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const gridSize = 1000;
const pixels = new Array(gridSize*gridSize);
canvas.width = canvas.clientWidth;
canvas.height = canvas.clientHeight;
const pfpCache = {}; // store images by username


let scale, minScale, offsetX, offsetY;
let dragging=false, lastX=0, lastY=0;
const dragThreshold = 5;

let verified=false;
let username=null;
let pixelsLeft=0;
let nextPixelTime=null;
let returnToken=null;
let verificationToken=null;

// --- Selected color ---
let activeColor = "#6d001a";

// --- Canvas view ---
function resetView(){
    minScale = Math.min(canvas.width/gridSize, canvas.height/gridSize);
    scale = minScale;
    offsetX = (canvas.width - gridSize*scale)/2;
    offsetY = (canvas.height - gridSize*scale)/2;
}
resetView();
function clampOffsets(){
    const maxOffsetX = 0, maxOffsetY=0;
    const minOffsetX = canvas.width - gridSize*scale, minOffsetY = canvas.height - gridSize*scale;
    if(offsetX>maxOffsetX) offsetX=maxOffsetX;
    if(offsetY>maxOffsetY) offsetY=maxOffsetY;
    if(offsetX<minOffsetX) offsetX=minOffsetX;
    if(offsetY<minOffsetY) offsetY=minOffsetY;
}
function drawBoard(){
    ctx.setTransform(scale,0,0,scale,offsetX,offsetY);
    ctx.clearRect(-offsetX/scale,-offsetY/scale,canvas.width/scale,canvas.height/scale);
    ctx.fillStyle="#222"; ctx.fillRect(0,0,gridSize,gridSize);

    for(let i=0;i<pixels.length;i++){
        if(pixels[i]){
            const x=i%gridSize, y=Math.floor(i/gridSize);
            if(pixels[i].color==="pfp" && pixels[i].pfp){
                if(!pfpCache[pixels[i].user]){
                    const img = new Image();
                    img.src = pixels[i].pfp;
                    pfpCache[pixels[i].user] = img;
                }
                ctx.drawImage(pfpCache[pixels[i].user], x, y, 1, 1);
            } else {
                ctx.fillStyle=pixels[i].color;
                ctx.fillRect(x,y,1,1);
            }
        }
    }
}

canvas.addEventListener("wheel", e=>{
    e.preventDefault();
    const mouseX=(e.offsetX-offsetX)/scale;
    const mouseY=(e.offsetY-offsetY)/scale;
    const zoom=e.deltaY<0?1.1:0.9;
    scale*=zoom;
    scale=Math.min(Math.max(scale,minScale),40);
    offsetX=e.offsetX - mouseX*scale;
    offsetY=e.offsetY - mouseY*scale;
    clampOffsets();
    drawBoard();
});

canvas.addEventListener("mousedown", e=>{
    if(e.button===0){ lastX=e.clientX; lastY=e.clientY; dragging=false; }
});

canvas.addEventListener("mousemove", e=>{
    const rect = canvas.getBoundingClientRect();
    const x = Math.floor((e.clientX - rect.left - offsetX) / scale);
    const y = Math.floor((e.clientY - rect.top - offsetY) / scale);
    const index = y * gridSize + x;
    const pixel = pixels[index];

    const hoverPanel = document.getElementById("hoverInfo");
    const hoverPfp = document.getElementById("hoverPfp");
    const hoverName = document.getElementById("hoverName");

    if(pixel && pixel.user){
        hoverPanel.style.display="block";
        hoverPanel.style.left = (e.pageX + 10) + "px";
        hoverPanel.style.top = (e.pageY + 10) + "px";
        hoverPfp.src = pixel.pfp || `https://www.tiktok.com/@${pixel.user}/avatar`;
        hoverName.textContent = pixel.user;
    } else {
        hoverPanel.style.display="none";
    }

    if(e.buttons===1){
        if(Math.abs(e.clientX-lastX)>dragThreshold || Math.abs(e.clientY-lastY)>dragThreshold) dragging=true;
        if(dragging){ offsetX+=e.clientX-lastX; offsetY+=e.clientY-lastY; lastX=e.clientX; lastY=e.clientY; clampOffsets(); drawBoard(); }
    }
});

canvas.addEventListener("mouseup", e=>{
    if(!dragging){
        if(!verified){ alert("Not verified!"); return; }
        if(pixelsLeft<=0){ alert("No pixels available!"); return; }
        const x=Math.floor((e.offsetX-offsetX)/scale);
        const y=Math.floor((e.offsetY-offsetY)/scale);
        if(x>=0 && y>=0 && x<gridSize && y<gridSize){
            ws.send(JSON.stringify({action:"place_pixel", session:currentSession, index:x+y*gridSize, color:activeColor}));
        }
    }
    dragging=false;
});

// --- Color selection ---
document.querySelectorAll("#colorPalette .color").forEach(c=>{
    c.addEventListener("click", ()=>{
        document.querySelectorAll("#colorPalette .color").forEach(cl=>cl.classList.remove("selected"));
        c.classList.add("selected");
        activeColor = c.getAttribute("data-color");
    });
});

// --- User info ---
function updateUserInfo(){
    const infoDiv = document.getElementById("userInfo");
    let timeLeft = 0;
    if(nextPixelTime) timeLeft = Math.max(0, Math.floor(nextPixelTime - Date.now()/1000));
    infoDiv.textContent = username ? 
        `Welcome back ${username} | Pixels left: ${pixelsLeft} | Cooldown: ${timeLeft}s`
        : `Not verified`;
}

// --- Countdown ---
setInterval(()=>{
    if(!verified || !nextPixelTime) return;
    const now = Date.now()/1000;
    if(now >= nextPixelTime){ pixelsLeft++; nextPixelTime=now+5; }
    updateUserInfo();
}, 1000);

// --- WebSocket ---
ws.onopen = ()=> console.log("âœ… WS connected!");
ws.onmessage = e=>{
    const msg = JSON.parse(e.data);
    if(msg.type==="init_pixels"){ 
        for(const idx in msg.pixels){ pixels[idx] = msg.pixels[idx]; }
        drawBoard(); 
    }
    else if(msg.type==="token"){ 
        verificationToken=msg.token; returnToken=msg.return_token; 
        document.getElementById("verificationToken").value=verificationToken; 
        document.getElementById("returnToken").value=returnToken; 
        document.getElementById("status").textContent="Type verification token in TikTok chat!"; 
    }
    else if(msg.type==="verified"){ 
        if(msg.session===currentSession){ 
            verified=true; username=msg.username; 
            pixelsLeft=msg.pixels_left ?? 1; 
            nextPixelTime=msg.next_pixel_time ?? (Date.now()/1000+5); 
            returnToken=msg.return_token ?? returnToken; 
            document.getElementById("status").textContent=`VERIFIED! Welcome ${username}`; 
            document.getElementById("returnToken").value=returnToken; 
            document.getElementById("palette-panel").style.display="block"; 
        } 
    }
    else if(msg.type==="pixel"){ 
        pixels[msg.index] = { color: msg.color, user: msg.user, pfp: msg.pfp }; 
        if(msg.session===currentSession){ pixelsLeft=Math.max(0,pixelsLeft-1); nextPixelTime=Date.now()/1000+5; } 
        drawBoard(); 
    }
    else if(msg.type==="clear_user"){ 
        const removed=msg.sessionMap; 
        for(const idx in removed){ pixels[Number(idx)]=null; } 
        drawBoard(); 
    }
    else if(msg.type==="clear_all"){
        const removed = msg.sessionMap;
        for(const idx in removed){ pixels[Number(idx)] = null; }
        drawBoard();
    }
    else if(msg.type==="error"){ if(msg.session===undefined || msg.session===currentSession) alert(msg.message); }
};

// --- Generate token ---
document.getElementById("getTokenBtn").addEventListener("click", ()=> ws.send(JSON.stringify({action:"get_token", session:currentSession})));

// --- Return login ---
document.getElementById("returnLoginBtn").addEventListener("click", ()=>{
    const uname=document.getElementById("usernameInput").value.trim();
    const rtoken=document.getElementById("returnCodeInput").value.trim();
    if(!uname||!rtoken) return alert("Enter username and return token");
    ws.send(JSON.stringify({action:"verify", username:uname, token:rtoken, session:currentSession}));
});

// --- Admin ---
document.getElementById("adminLoginBtn").addEventListener("click", ()=> document.getElementById("adminPanel").style.display="block");
document.getElementById("adminVerifyBtn").addEventListener("click", ()=>{
    const key=document.getElementById("adminKeyInput").value.trim();
    if(!key) return alert("Enter admin key");
    ws.send(JSON.stringify({action:"admin", key:key, command:"check", session:currentSession}));
});
ws.addEventListener("message", e=>{
    const msg=JSON.parse(e.data);
    if(msg.type==="info" && msg.message==="Admin key correct"){ document.getElementById("adminControls").style.display="block"; alert("Admin verified!"); }
    else if(msg.type==="error" && msg.message==="Invalid admin key"){ alert("Invalid admin key!"); document.getElementById("adminControls").style.display="none"; }
});
document.getElementById("clearUserPixelsBtn").addEventListener("click", ()=>{
    const target=document.getElementById("adminUsername").value.trim();
    if(!target) return alert("Enter username");
    ws.send(JSON.stringify({action:"admin", key:document.getElementById("adminKeyInput").value, command:"clear_user", target}));
});
document.getElementById("unverifyUserBtn").addEventListener("click", ()=>{
    const target=document.getElementById("adminUsername").value.trim();
    if(!target) return alert("Enter username");
    ws.send(JSON.stringify({action:"admin", key:document.getElementById("adminKeyInput").value, command:"unverify", target}));
});
document.getElementById("clearAllBtn").addEventListener("click", ()=>{
    ws.send(JSON.stringify({action:"admin", key:document.getElementById("adminKeyInput").value, command:"clear"}));
});

drawBoard();
</script>
</body>
</html>
