<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TikTok Live R/Place</title>
<style>
  body { 
    background:#111; 
    color:white; 
    text-align:center; 
    font-family:Arial; 
  }
  #canvasContainer {
    width: 500px;
    height: 500px;
    margin: 20px auto;
    display: grid;
    grid-template-columns: repeat(25, 1fr);
    grid-template-rows: repeat(25, 1fr);
    gap: 1px;
  }
  .pixel {
    background: #222;
    width: 100%;
    height: 100%;
    cursor: pointer;
    transition: background 0.2s;
  }
  #login {
    margin-bottom: 10px;
  }
  input, button {
    margin: 5px;
    padding: 5px;
    font-size: 14px;
  }
</style>
</head>
<body>

<h1>TikTok R/Place</h1>

<div id="login">
  <input type="text" id="username" placeholder="Username">
  <input type="text" id="return_code" placeholder="Return Code">
  <button id="login_btn">Return Login</button>
  <button id="get_token_btn">Get TikTok Token</button>
</div>

<div id="info"></div>

<div id="canvasContainer"></div>

<script>
const GRID_SIZE = 25; // 25x25
const canvasContainer = document.getElementById('canvasContainer');
const info = document.getElementById('info');

let session = 'session_' + Math.floor(Math.random()*1000000);
let username = '';
let return_code = '';
let ws;

let pixels = {}; // idx -> session

// --- Build grid ---
for(let i=0;i<GRID_SIZE*GRID_SIZE;i++){
  const div = document.createElement('div');
  div.classList.add('pixel');
  div.dataset.idx = i;
  div.addEventListener('click', () => placePixel(i));
  canvasContainer.appendChild(div);
}

function connect() {
  ws = new WebSocket(`wss://tiktokliveweb-production.up.railway.app`);
  ws.onopen = () => info.innerText = 'Connected to server';
  ws.onmessage = (msg) => handleMsg(JSON.parse(msg.data));
  ws.onclose = () => info.innerText = 'Disconnected';
  ws.onerror = (err) => info.innerText = 'WebSocket error: ' + err.message;
}


connect();

// --- Handle incoming messages ---
function handleMsg(msg){
  if(msg.type === 'init_pixels'){
    pixels = msg.pixels || {};
    updateGrid();
  } else if(msg.type === 'pixel'){
    pixels[msg.index] = msg.session;
    updateGrid();
  } else if(msg.type === 'info'){
    info.innerText = msg.message;
  } else if(msg.type === 'error'){
    info.innerText = 'Error: ' + msg.message;
  } else if(msg.type === 'verified'){
    username = msg.username;
    return_code = msg.return_code || '';
    info.innerText = `Verified as ${username}. Pixels left: ${msg.pixels_left}. Return code: ${return_code}`;
  }
}

// --- Update grid colors ---
function updateGrid(){
  document.querySelectorAll('.pixel').forEach(div=>{
    const idx = div.dataset.idx;
    if(pixels[idx]){
      div.style.background = (pixels[idx] === session) ? 'white' : 'red';
    } else {
      div.style.background = '#222';
    }
  });
}

// --- Place pixel ---
function placePixel(idx){
  if(!username){
    alert('Login first!');
    return;
  }
  ws.send(JSON.stringify({
    action: 'place_pixel',
    session: session,
    index: idx
  }));
}

// --- Buttons ---
document.getElementById('login_btn').onclick = () => {
  username = document.getElementById('username').value.trim();
  return_code = document.getElementById('return_code').value.trim();
  if(!username || !return_code) return alert('Enter username and return code');
  ws.send(JSON.stringify({
    action: 'return_login',
    session: session,
    username,
    return_code
  }));
};

document.getElementById('get_token_btn').onclick = () => {
  ws.send(JSON.stringify({
    action: 'get_token',
    session
  }));
  info.innerText = 'Token requested. Check TikTok chat for it!';
};
</script>

</body>
</html>



