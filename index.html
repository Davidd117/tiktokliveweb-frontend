<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TikTok Live R/Place</title>
<style>
  body { background:#111; color:white; text-align:center; font-family:Arial; }
  #canvasContainer { width:800px; height:800px; margin:20px auto; border:2px solid #444; background:#222; overflow:hidden; cursor:grab; }
  canvas { width:100%; height:100%; display:block; }
  #adminPanel { display:none; background:#222; padding:10px; border:1px solid #555; margin-top:20px; }
  input, button { padding:5px; margin:5px; }
</style>
</head>
<body>

<h2>TikTok Live R/Place</h2>

<div>
  <input id="usernameInput" placeholder="Enter username">
  <button id="getTokenBtn">Get Verification Token</button>
</div>
<div id="tokenDisplay"></div>
<div id="status">Not verified</div>

<div id="canvasContainer">
  <canvas id="canvas"></canvas>
</div>

<div id="adminAuth">
  <input id="adminKey" placeholder="Admin Key">
  <button id="adminLoginBtn">Login as Admin</button>
</div>

<div id="adminPanel">
  <h3>Admin Panel</h3>
  <input id="adminUsername" placeholder="Username">
  <button id="banUserBtn">Ban User</button>
  <button id="unbanUserBtn">Unban User</button>
  <button id="removeUserBtn">Remove Verified User</button>
  <button id="clearPixelsBtn">Clear Board</button>
</div>

<script>
// ======= WebSocket URL =======
// Automatically switch between local and deployed server
const DEFAULT_WS_URL = "ws://localhost:8765"; // local dev
const RAILWAY_WS_URL = "wss://YOUR_APP.up.railway.app"; // replace with your Railway app
const ws = new WebSocket(location.hostname.includes("localhost") ? DEFAULT_WS_URL : RAILWAY_WS_URL);

// ======= Canvas Setup =======
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const gridSize = 1000;
const pixels = new Uint8Array(gridSize*gridSize);
canvas.width = canvas.clientWidth;
canvas.height = canvas.clientHeight;

let scale, minScale, offsetX, offsetY;
let dragging=false, lastX, lastY;
let verified=false, currentUser="";

function resetView(){
  minScale = Math.min(canvas.width/gridSize, canvas.height/gridSize);
  scale = minScale;
  offsetX = (canvas.width - gridSize*scale)/2;
  offsetY = (canvas.height - gridSize*scale)/2;
}
resetView();

function clampOffsets(){
  const maxOffsetX=0, maxOffsetY=0;
  const minOffsetX=canvas.width - gridSize*scale;
  const minOffsetY=canvas.height - gridSize*scale;
  if(offsetX>maxOffsetX) offsetX=maxOffsetX;
  if(offsetY>maxOffsetY) offsetY=maxOffsetY;
  if(offsetX<minOffsetX) offsetX=minOffsetX;
  if(offsetY<minOffsetY) offsetY=minOffsetY;
}

function drawBoard(){
  ctx.setTransform(scale,0,0,scale,offsetX,offsetY);
  ctx.clearRect(-offsetX/scale,-offsetY/scale,canvas.width/scale,canvas.height/scale);
  ctx.fillStyle="#222"; ctx.fillRect(0,0,gridSize,gridSize);
  if(scale>4){
    ctx.strokeStyle="#333"; ctx.lineWidth=0.05;
    for(let x=0;x<gridSize;x++){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,gridSize);ctx.stroke();}
    for(let y=0;y<gridSize;y++){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(gridSize,y);ctx.stroke();}
  }
  for(let i=0;i<pixels.length;i++){
    if(pixels[i]){
      const x=i%gridSize, y=Math.floor(i/gridSize);
      ctx.fillStyle="#4ce0ff";
      ctx.fillRect(x,y,1,1);
    }
  }
}
drawBoard();

// ======= Canvas Zoom/Pan =======
canvas.addEventListener("wheel", e=>{
  e.preventDefault();
  const mx=(e.offsetX-offsetX)/scale, my=(e.offsetY-offsetY)/scale;
  const zoom = e.deltaY<0?1.1:0.9;
  scale*=zoom;
  scale=Math.min(Math.max(scale,minScale),40);
  offsetX = e.offsetX - mx*scale;
  offsetY = e.offsetY - my*scale;
  clampOffsets();
  drawBoard();
});

canvas.addEventListener("mousedown", e=>{
  if(e.button===1){dragging=true; lastX=e.clientX; lastY=e.clientY; canvas.style.cursor="grabbing"; e.preventDefault();}
});
canvas.addEventListener("mousemove", e=>{
  if(dragging){ offsetX+=e.clientX-lastX; offsetY+=e.clientY-lastY; lastX=e.clientX; lastY=e.clientY; clampOffsets(); drawBoard();}
});
canvas.addEventListener("mouseup", e=>{if(e.button===1){dragging=false; canvas.style.cursor="grab";}});

// ======= Place Pixel =======
canvas.addEventListener("click", e=>{
  if(e.button!==0) return;
  if(!verified){ alert("You are not verified!"); return; }
  const x=Math.floor((e.offsetX-offsetX)/scale);
  const y=Math.floor((e.offsetY-offsetY)/scale);
  if(x>=0 && y>=0 && x<gridSize && y<gridSize){
    ws.send(JSON.stringify({action:"place_pixel", username:currentUser, index:x+y*gridSize}));
  }
});

// ======= User Verification =======
document.getElementById("getTokenBtn").addEventListener("click", ()=>{
  const username=document.getElementById("usernameInput").value.trim();
  if(!username) return alert("Enter username");
  currentUser=username;
  ws.send(JSON.stringify({action:"get_token", username}));
});

// ======= Admin Login =======
document.getElementById("adminLoginBtn").addEventListener("click", ()=>{
  const key=document.getElementById("adminKey").value.trim();
  ws.send(JSON.stringify({action:"admin", key, command:"login_check"}));
});

// ======= Admin Actions =======
const sendAdminCommand = cmd=>{
  const username=document.getElementById("adminUsername").value.trim();
  const key=document.getElementById("adminKey").value.trim();
  ws.send(JSON.stringify({action:"admin", key, command:cmd, username}));
};
document.getElementById("banUserBtn").addEventListener("click", ()=>sendAdminCommand("ban"));
document.getElementById("unbanUserBtn").addEventListener("click", ()=>sendAdminCommand("unban"));
document.getElementById("removeUserBtn").addEventListener("click", ()=>sendAdminCommand("remove_user"));
document.getElementById("clearPixelsBtn").addEventListener("click", ()=>sendAdminCommand("clear_pixels"));

// ======= WebSocket Events =======
ws.addEventListener("open", ()=>console.log("WebSocket connected"));
ws.addEventListener("message", e=>{
  const msg=JSON.parse(e.data);
  if(msg.token){
    document.getElementById("tokenDisplay").textContent="Your token: "+msg.token;
    document.getElementById("status").textContent="Type this token in TikTok Live to verify";
  } else if(msg.type==="verified"){
    verified=true; currentUser=msg.user;
    document.getElementById("status").textContent=currentUser+" VERIFIED! You can place 1 pixel";
  } else if(msg.type==="pixel"){
    const i=msg.index; pixels[i]=1; drawBoard();
  } else if(msg.type==="already_verified"){
    verified=true; currentUser=msg.user;
    document.getElementById("status").textContent=currentUser+" already verified!";
  } else if(msg.type==="clear"){
    for(let i=0;i<pixels.length;i++) pixels[i]=0; drawBoard();
  } else if(msg.type==="error"){
    alert(msg.message);
  } else if(msg.type==="admin_ok"){
    if(msg.message==="login_success"){
      document.getElementById("adminPanel").style.display="block";
      document.getElementById("adminAuth").style.display="none";
      alert("Admin connected!");
    } else alert(msg.message);
  }
});
</script>
</body>
</html>
