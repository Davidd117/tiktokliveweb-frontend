<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TikTok Live R/Place</title>
<style>
  body { background:#111; color:white; text-align:center; font-family:Arial; }
  #canvasContainer { width:800px; height:800px; margin:20px auto; border:2px solid #444; background:#222; cursor:grab; }
  canvas { width:100%; height:100%; display:block; }
  input, button { padding:5px; margin:5px; }
</style>
</head>
<body>
<h2>TikTok Live R/Place</h2>

<button id="getTokenBtn">Generate Verification Token</button>
<div id="tokenDisplay">Token will appear here</div>
<div id="status">Not verified</div>

<div id="canvasContainer">
  <canvas id="canvas"></canvas>
</div>

<script>
// Unique session per tab
const session = 'session_' + Math.random().toString(36).substring(2,10);

const ws = new WebSocket("wss://tiktokliveweb-production.up.railway.app");
ws.onopen = () => console.log("WebSocket connected");
ws.onmessage = (msg) => console.log("Server:", msg.data);

// --- Generate Token ---
document.getElementById("getTokenBtn").addEventListener("click", ()=>{
  ws.send(JSON.stringify({action:"get_token", session}));
});

// --- Canvas Setup ---
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const gridSize = 500;
const pixels = new Uint8Array(gridSize*gridSize);
canvas.width = canvas.clientWidth;
canvas.height = canvas.clientHeight;
let scale=1, offsetX=0, offsetY=0;
let verified=false;

function drawBoard(){
  ctx.setTransform(scale,0,0,scale,offsetX,offsetY);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="#222"; ctx.fillRect(0,0,gridSize,gridSize);
  for(let i=0;i<pixels.length;i++){
    if(pixels[i]){
      const x=i%gridSize, y=Math.floor(i/gridSize);
      ctx.fillStyle="#4ce0ff";
      ctx.fillRect(x,y,1,1);
    }
  }
}
drawBoard();

// --- Place Pixel ---
canvas.addEventListener("click", e=>{
  if(!verified){ alert("Not verified!"); return; }
  const x=Math.floor(e.offsetX/scale);
  const y=Math.floor(e.offsetY/scale);
  if(x>=0 && y>=0 && x<gridSize && y<gridSize){
    ws.send(JSON.stringify({action:"place_pixel", session, index:x+y*gridSize}));
  }
});

// --- Receive Updates ---
ws.onmessage = e=>{
  const msg=JSON.parse(e.data);
  if(msg.type==="token"){
    document.getElementById("tokenDisplay").textContent="Your token: "+msg.token;
    document.getElementById("status").textContent="Enter this token in TikTok Live to verify";
  }
  else if(msg.type==="verified" && msg.session===session){
    verified=true;
    document.getElementById("status").textContent="Verified! You can place 1 pixel";
  }
  else if(msg.type==="pixel"){
    pixels[msg.index]=1; drawBoard();
  }
  else if(msg.type==="clear"){
    for(let i=0;i<pixels.length;i++) pixels[i]=0; drawBoard();
  }
  else if(msg.type==="error"){
    alert(msg.message);
  }
};
</script>
</body>
</html>
