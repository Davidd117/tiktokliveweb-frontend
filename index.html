<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TikTok Live R/Place</title>
<style>
  body { background:#111; color:white; text-align:center; font-family:Arial; }
  #canvasContainer {
    width: 800px;
    height: 800px;
    margin: 20px auto;
    border: 2px solid #444;
    background: #222;
    overflow: hidden;
    cursor: grab;
  }
  canvas { width:100%; height:100%; display:block; }
  #adminPanel { display:none; background:#222; padding:10px; border:1px solid #555; margin-top:20px; }
  input, button { padding:5px; margin:5px; }
</style>
</head>
<body>
<h2>TikTok Live R/Place</h2>

<div>
  <button id="getTokenBtn">Generate Verification Token</button>
</div>
<div id="tokenDisplay">Token will appear here</div>
<div id="status">Not verified</div>

<div id="canvasContainer">
  <canvas id="canvas"></canvas>
</div>

<div id="adminAuth">
  <input id="adminKey" placeholder="Admin Key">
  <button id="adminLoginBtn">Login as Admin</button>
</div>
<div id="adminPanel">
  <h3>Admin Panel</h3>
  <input id="adminUsername" placeholder="Username">
  <button id="banUserBtn">Ban User</button>
  <button id="unbanUserBtn">Unban User</button>
  <button id="removeUserBtn">Remove Verified User</button>
  <button id="clearPixelsBtn">Clear Board</button>
</div>

<script>
// Generate a unique session ID per browser/tab
const currentSession = 'session_' + Math.random().toString(36).substring(2, 10);
let verified = false;

const ws = new WebSocket("wss://tiktokliveweb-production.up.railway.app");
ws.onopen = () => console.log("âœ… WebSocket connected!");

ws.onmessage = (msg) => {
    const data = JSON.parse(msg.data);

    switch(data.type){
        case "token":
            document.getElementById("tokenDisplay").textContent="Your token: "+data.token;
            document.getElementById("status").textContent="Type this token in TikTok Live to verify";
            console.log("[Token generated]", data.token);
            break;

        case "verified":
            if(!verified){
                verified = true;
                document.getElementById("status").textContent="Verified! You can place 1 pixel";
                console.log("[Verified]", data.user);
            }
            break;

        case "already_verified":
            if(!verified){
                verified = true;
                document.getElementById("status").textContent="Already verified! You can place 1 pixel";
            }
            break;

        case "pixel":
            drawPixel(data.index);
            break;

        case "clear":
            clearGrid();
            break;

        case "full_grid":
            loadFullGrid(data.pixels);
            break;

        case "error":
            alert(data.message);
            break;

        case "admin_ok":
            if(data.message==="login_success"){
                document.getElementById("adminPanel").style.display="block";
                document.getElementById("adminAuth").style.display="none";
                alert("Admin connected!");
            } else alert(data.message);
            break;
    }
});

// --- Admin Buttons ---
document.getElementById("getTokenBtn").addEventListener("click", ()=>{
    ws.send(JSON.stringify({action:"get_token", username: currentSession}));
});

document.getElementById("adminLoginBtn").addEventListener("click", ()=>{
    const key = document.getElementById("adminKey").value.trim();
    ws.send(JSON.stringify({action:"admin", key, command:"login_check"}));
});

document.getElementById("banUserBtn").addEventListener("click", ()=>{
    const username = document.getElementById("adminUsername").value.trim();
    ws.send(JSON.stringify({action:"admin", key:document.getElementById("adminKey").value.trim(), command:"ban", username}));
});
document.getElementById("unbanUserBtn").addEventListener("click", ()=>{
    const username = document.getElementById("adminUsername").value.trim();
    ws.send(JSON.stringify({action:"admin", key:document.getElementById("adminKey").value.trim(), command:"unban", username}));
});
document.getElementById("removeUserBtn").addEventListener("click", ()=>{
    const username = document.getElementById("adminUsername").value.trim();
    ws.send(JSON.stringify({action:"admin", key:document.getElementById("adminKey").value.trim(), command:"remove_user", username}));
});
document.getElementById("clearPixelsBtn").addEventListener("click", ()=>{
    ws.send(JSON.stringify({action:"admin", key:document.getElementById("adminKey").value.trim(), command:"clear_pixels"}));
});

// --- Canvas Setup ---
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const gridSize = 1000;
let pixels = new Uint8Array(gridSize*gridSize);
canvas.width = canvas.clientWidth;
canvas.height = canvas.clientHeight;

let scale, minScale, offsetX, offsetY;
let dragging = false, lastX, lastY;

function resetView(){
    minScale = Math.min(canvas.width/gridSize, canvas.height/gridSize);
    scale = minScale;
    offsetX = (canvas.width - gridSize*scale)/2;
    offsetY = (canvas.height - gridSize*scale)/2;
}
resetView();

function clampOffsets(){
    const maxOffsetX = 0, maxOffsetY = 0;
    const minOffsetX = canvas.width - gridSize*scale;
    const minOffsetY = canvas.height - gridSize*scale;
    if(offsetX>maxOffsetX) offsetX=maxOffsetX;
    if(offsetY>maxOffsetY) offsetY=maxOffsetY;
    if(offsetX<minOffsetX) offsetX=minOffsetX;
    if(offsetY<minOffsetY) offsetY=minOffsetY;
}

function drawBoard(){
    ctx.setTransform(scale,0,0,scale,offsetX,offsetY);
    ctx.clearRect(-offsetX/scale,-offsetY/scale,canvas.width/scale,canvas.height/scale);
    ctx.fillStyle="#222"; ctx.fillRect(0,0,gridSize,gridSize);
    if(scale>4){
        ctx.strokeStyle="#333"; ctx.lineWidth=0.05;
        for(let x=0;x<gridSize;x++){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,gridSize);ctx.stroke();}
        for(let y=0;y<gridSize;y++){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(gridSize,y);ctx.stroke();}
    }
    for(let i=0;i<pixels.length;i++){
        if(pixels[i]){
            const x=i%gridSize, y=Math.floor(i/gridSize);
            ctx.fillStyle="#4ce0ff";
            ctx.fillRect(x,y,1,1);
        }
    }
}
drawBoard();

function drawPixel(i){
    if(i>=0 && i<pixels.length){
        pixels[i]=1;
        const x=i%gridSize, y=Math.floor(i/gridSize);
        ctx.setTransform(scale,0,0,scale,offsetX,offsetY);
        ctx.fillStyle="#4ce0ff";
        ctx.fillRect(x,y,1,1);
    }
}

function clearGrid(){
    pixels = new Uint8Array(gridSize*gridSize);
    drawBoard();
}

function loadFullGrid(gridData){
    pixels = new Uint8Array(gridSize*gridSize);
    for(const idx in gridData){
        const i = parseInt(idx);
        pixels[i]=1;
    }
    drawBoard();
}

// --- Zoom & Pan ---
canvas.addEventListener("wheel", e=>{
    e.preventDefault();
    const mouseX=(e.offsetX-offsetX)/scale;
    const mouseY=(e.offsetY-offsetY)/scale;
    const zoom=e.deltaY<0?1.1:0.9;
    scale*=zoom;
    scale=Math.min(Math.max(scale,minScale),40);
    offsetX=e.offsetX - mouseX*scale;
    offsetY=e.offsetY - mouseY*scale;
    clampOffsets();
    drawBoard();
});

canvas.addEventListener("mousedown", e=>{
    if(e.button===1){dragging=true; lastX=e.clientX; lastY=e.clientY; canvas.style.cursor="grabbing"; e.preventDefault();}
});
canvas.addEventListener("mousemove", e=>{
    if(dragging){ offsetX+=e.clientX-lastX; offsetY+=e.clientY-lastY; lastX=e.clientX; lastY=e.clientY; clampOffsets(); drawBoard(); }
});
canvas.addEventListener("mouseup", e=>{if(e.button===1){dragging=false; canvas.style.cursor="grab";}});

// --- Place Pixel ---
canvas.addEventListener("click", e=>{
    if(e.button!==0) return;
    if(!verified){ alert("You are not verified!"); return; }
    const x=Math.floor((e.offsetX-offsetX)/scale);
    const y=Math.floor((e.offsetY-offsetY)/scale);
    if(x>=0 && y>=0 && x<gridSize && y<gridSize){
        ws.send(JSON.stringify({action:"place_pixel", username:currentSession, index:x+y*gridSize}));
    }
});
</script>
</body>
</html>
