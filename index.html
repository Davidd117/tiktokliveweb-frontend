<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>rPlace Clone</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #eee; }
    #grid { display: grid; grid-template-columns: repeat(20, 20px); grid-gap: 1px; margin: 20px auto; }
    .cell { width: 20px; height: 20px; background: #333; cursor: pointer; }
    #status { margin-top: 15px; font-size: 14px; }
    #cooldown { color: #0f0; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Mini r/place</h2>
  <div id="grid"></div>
  <div id="status">
    <p>Pixels left: <span id="pixels">0</span></p>
    <p>Next pixel in: <span id="cooldown">--</span></p>
  </div>
  <input id="token" placeholder="Enter token">
  <button onclick="verify()">Verify</button>

  <script>
    const ws = new WebSocket("ws://localhost:6789");
    const grid = document.getElementById("grid");
    const size = 20 * 20; // 20x20 grid
    const pixelCountEl = document.getElementById("pixels");
    const cooldownEl = document.getElementById("cooldown");

    let sessionId = null;
    let pixelsLeft = 0;
    let nextPixelTime = null;
    let cooldownTimer = null;

    // Build grid
    for (let i = 0; i < size; i++) {
      const cell = document.createElement("div");
      cell.className = "cell";
      cell.dataset.index = i;
      cell.onclick = () => placePixel(i);
      grid.appendChild(cell);
    }

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.type === "session") {
        sessionId = data.session;
        console.log("Session ID:", sessionId);
      }
      else if (data.type === "pixel") {
        document.querySelector(`[data-index='${data.index}']`).style.background = "#0ff";
      }
      else if (data.type === "verified") {
        console.log("Verified as:", data.username);
      }
      else if (data.type === "info") {
        pixelsLeft = data.pixels_left;
        nextPixelTime = data.next_pixel_time;
        updateUI();
      }
      else if (data.type === "error") {
        alert(data.message);
      }
    };

    function verify() {
      const token = document.getElementById("token").value;
      if (!token) return;
      ws.send(JSON.stringify({ action: "verify", token: token }));
    }

    function placePixel(index) {
      if (pixelsLeft <= 0) {
        alert("No pixels left!");
        return;
      }
      ws.send(JSON.stringify({ action: "place_pixel", index: index }));
    }

    function updateUI() {
      pixelCountEl.textContent = pixelsLeft;

      if (cooldownTimer) clearInterval(cooldownTimer);

      if (nextPixelTime) {
        cooldownTimer = setInterval(() => {
          const now = Math.floor(Date.now() / 1000);
          const remaining = Math.max(0, Math.floor(nextPixelTime - now));

          cooldownEl.textContent = remaining + " sec";

          if (remaining <= 0) {
            // Pixel auto-replenished by server loop
            pixelsLeft += 1;
            pixelCountEl.textContent = pixelsLeft;

            // Start next cooldown immediately
            nextPixelTime = now + 10 * 60; // match server cooldown
          }
        }, 1000);
      } else {
        cooldownEl.textContent = "--";
      }
    }
  </script>
</body>
</html>
