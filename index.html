<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TikTok Live R/Place</title>
<style>
  body { background:#111; color:white; text-align:center; font-family:Arial; }
  #canvasContainer { width: 800px; height: 800px; margin: 20px auto; border: 2px solid #444; background: #222; overflow: hidden; cursor: grab; }
  canvas { width:100%; height:100%; display:block; }
  input, button { padding:5px; margin:5px; }
  #userInfo { margin-top: 10px; }
  #adminPanel { display:none; background:#222; padding:10px; border:1px solid #555; margin:10px auto; width:300px; }

  /* ðŸŽ¨ Palette styles */
  #palette-panel {
    display:none;
    background:#222;
    padding:10px;
    border:1px solid #555;
    margin:15px auto;
    width:320px;
    text-align:center;
  }
  .palette-section { margin-bottom: 10px; }
  .colors { display: flex; gap: 5px; flex-wrap: wrap; justify-content:center; }
  .color {
    width: 30px; height: 30px;
    cursor: pointer; border-radius: 4px;
    border: 2px solid transparent;
  }
  .color.selected { border: 2px solid #fff; }
  .color.locked {
    background: repeating-linear-gradient(
      45deg, #555, #555 5px, #777 5px, #777 10px
    );
    cursor: not-allowed;
  }
  .locked { opacity: 0.4; }
</style>
</head>
<body>
<h2>TikTok Live R/Place</h2>

<div>
  <button id="getTokenBtn">Generate Verification Token</button>
</div>
<div>
  <label>Verification Token (copy to TikTok chat):</label>
  <input type="text" id="verificationToken" readonly style="width:300px;">
</div>
<div>
  <label>Return Token (save this for login):</label>
  <input type="text" id="returnToken" readonly style="width:300px;">
</div>
<div>
  <input type="text" id="usernameInput" placeholder="TikTok Username">
  <input type="text" id="returnCodeInput" placeholder="Return Token">
  <button id="returnLoginBtn">Return Login</button>
</div>

<div id="status">Not verified</div>
<div id="userInfo"></div>

<div id="canvasContainer">
  <canvas id="canvas"></canvas>
</div>

<!-- ðŸŽ¨ Palette panel -->
<div id="palette-panel">
  <h3>ðŸŽ¨ Color Palette</h3>

  <!-- Basic -->
  <div id="basic-palette" class="palette-section">
    <h4>Basic</h4>
    <div class="colors">
      <div class="color" data-color="#000000" style="background:#000000;"></div>
      <div class="color" data-color="#ffffff" style="background:#ffffff; border:1px solid #ccc;"></div>
      <div class="color" data-color="#ff0000" style="background:#ff0000;"></div>
      <div class="color" data-color="#00ff00" style="background:#00ff00;"></div>
      <div class="color" data-color="#0000ff" style="background:#0000ff;"></div>
      <div class="color" data-color="#ffff00" style="background:#ffff00;"></div>
      <div class="color" data-color="#ff00ff" style="background:#ff00ff;"></div>
      <div class="color" data-color="#00ffff" style="background:#00ffff;"></div>
    </div>
  </div>

  <!-- Advanced (Locked) -->
  <div id="advanced-palette" class="palette-section locked">
    <h4>Advanced (Locked)</h4>
    <div class="colors">
      <div class="color locked"></div>
      <div class="color locked"></div>
      <div class="color locked"></div>
    </div>
  </div>

  <!-- Pro (Locked) -->
  <div id="pro-palette" class="palette-section locked">
    <h4>Pro (Locked)</h4>
    <input type="color" disabled>
    <input type="range" min="0" max="100" value="100" disabled>
  </div>
</div>

<div>
  <button id="adminLoginBtn">Admin Login</button>
</div>
<div id="adminPanel">
  <input type="text" id="adminKeyInput" placeholder="Admin Key">
  <button id="adminVerifyBtn">Verify Admin</button>
  <div id="adminControls" style="display:none;">
    <input type="text" id="adminUsername" placeholder="Username">
    <button id="clearUserPixelsBtn">Clear User Pixels</button>
    <button id="unverifyUserBtn">Unverify User</button>
    <button id="clearAllBtn">Clear All Pixels</button>
  </div>
</div>

<script>
const currentSession = 'session_' + Math.random().toString(36).substring(2, 10);
const ws = new WebSocket("wss://tiktokliveweb-production.up.railway.app");

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const gridSize = 1000;
const pixels = new Uint8Array(gridSize*gridSize);
canvas.width = canvas.clientWidth;
canvas.height = canvas.clientHeight;

let scale, minScale, offsetX, offsetY;
let dragging=false, lastX=0, lastY=0;
const dragThreshold = 5;

let verified=false;
let username=null;
let pixelsLeft=0;
let nextPixelTime=null;
let returnToken=null;
let verificationToken=null;

// ðŸŽ¨ Color palette state
let activeColor = "#000000"; // default black

// --- Canvas view ---
function resetView(){
    minScale = Math.min(canvas.width/gridSize, canvas.height/gridSize);
    scale = minScale;
    offsetX = (canvas.width - gridSize*scale)/2;
    offsetY = (canvas.height - gridSize*scale)/2;
}
resetView();
function clampOffsets(){
    const maxOffsetX = 0, maxOffsetY=0;
    const minOffsetX = canvas.width - gridSize*scale, minOffsetY = canvas.height - gridSize*scale;
    if(offsetX>maxOffsetX) offsetX=maxOffsetX;
    if(offsetY>maxOffsetY) offsetY=maxOffsetY;
    if(offsetX<minOffsetX) offsetX=minOffsetX;
    if(offsetY<minOffsetY) offsetY=minOffsetY;
}
function drawBoard(){
    ctx.setTransform(scale,0,0,scale,offsetX,offsetY);
    ctx.clearRect(-offsetX/scale,-offsetY/scale,canvas.width/scale,canvas.height/scale);
    ctx.fillStyle="#222"; ctx.fillRect(0,0,gridSize,gridSize);
    if(scale>4){
        ctx.strokeStyle="#333"; ctx.lineWidth=0.05;
        for(let x=0;x<gridSize;x++){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,gridSize);ctx.stroke();}
        for(let y=0;y<gridSize;y++){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(gridSize,y);ctx.stroke();}
    }
    for (const idx in pixels) {
        const p = pixels[idx];
        if (!p) continue;
        const x = idx % gridSize;
        const y = Math.floor(idx / gridSize);
        ctx.fillStyle = p.color;  // âœ… use color
        ctx.fillRect(x, y, 1, 1);
    }

}
canvas.addEventListener("wheel", e=>{
    e.preventDefault();
    const mouseX=(e.offsetX-offsetX)/scale;
    const mouseY=(e.offsetY-offsetY)/scale;
    const zoom=e.deltaY<0?1.1:0.9;
    scale*=zoom;
    scale=Math.min(Math.max(scale,minScale),40);
    offsetX=e.offsetX - mouseX*scale;
    offsetY=e.offsetY - mouseY*scale;
    clampOffsets();
    drawBoard();
});
canvas.addEventListener("mousedown", e=>{
    if(e.button===0){ lastX=e.clientX; lastY=e.clientY; dragging=false; }
});
canvas.addEventListener("mousemove", e=>{
    if(e.buttons===1){
        if(Math.abs(e.clientX-lastX)>dragThreshold || Math.abs(e.clientY-lastY)>dragThreshold){
            dragging=true;
        }
        if(dragging){
            offsetX += e.clientX-lastX;
            offsetY += e.clientY-lastY;
            lastX=e.clientX; lastY=e.clientY;
            clampOffsets();
            drawBoard();
        }
    }
});
canvas.addEventListener("mouseup", e=>{
    if(!dragging){
        if(!verified){ alert("Not verified!"); return; }
        if(pixelsLeft<=0){ alert("No pixels available!"); return; }
        const x=Math.floor((e.offsetX-offsetX)/scale);
        const y=Math.floor((e.offsetY-offsetY)/scale);
        if(x>=0 && y>=0 && x<gridSize && y<gridSize){
            ws.send(JSON.stringify({
              action:"place_pixel",
              session:currentSession,
              index:x+y*gridSize,
              color: activeColor,
              username: username
            }));
        }
    }
    dragging=false;
});

// --- Update user info ---
function updateUserInfo(){
    const infoDiv = document.getElementById("userInfo");
    let timeLeft = 0;
    if(nextPixelTime) timeLeft = Math.max(0, Math.floor(nextPixelTime - Date.now()/1000));
    infoDiv.textContent = username ? 
        `Welcome back ${username} | Pixels left: ${pixelsLeft} | Cooldown: ${timeLeft}s`
        : `Not verified`;
}

// --- Countdown ---
setInterval(()=>{
    if(!verified || !nextPixelTime) return;
    const now = Date.now()/1000;
    if(now >= nextPixelTime){
        pixelsLeft++;
        nextPixelTime = now + 5; // server cooldown
    }
    updateUserInfo();
}, 1000);

// --- WebSocket ---
ws.onopen = ()=> console.log("âœ… WS connected!");
ws.onmessage = e=>{
    const msg = JSON.parse(e.data);
    if(msg.type==="init_pixels"){ for(const idx in msg.pixels){ pixels[idx]=msg.pixels[idx]; } drawBoard(); }
    else if(msg.type==="token"){
        verificationToken = msg.token;
        returnToken = msg.return_token;
        document.getElementById("verificationToken").value = verificationToken;
        document.getElementById("returnToken").value = returnToken;
        document.getElementById("status").textContent = "Type verification token in TikTok chat!";
    }
    else if(msg.type==="verified"){
        if(msg.session===currentSession){
            verified=true;
            username=msg.username;
            pixelsLeft = msg.pixels_left ?? 1;
            nextPixelTime = msg.next_pixel_time ?? (Date.now()/1000 + 5);
            returnToken = msg.return_token ?? returnToken;
            document.getElementById("status").textContent=`VERIFIED! Welcome ${username}`;
            document.getElementById("returnToken").value = returnToken;
            document.getElementById("palette-panel").style.display="block"; // ðŸŽ¨ show palette
        }
    }
    else if (msg.type === "init_pixels") {
        pixels = {}; // reset
        for (const idx in msg.pixels) {
            pixels[idx] = msg.pixels[idx]; // already {user, color}
        }
        drawBoard();
    }
    else if(msg.type==="pixel"){
        pixels[msg.index]=msg.color; // store color hex
        if(msg.session===currentSession){ pixelsLeft = Math.max(0,pixelsLeft-1); nextPixelTime = Date.now()/1000 + 5; }
        drawBoard();
    }
    else if(msg.type==="clear_user"){  
        for(const idx in msg.sessionMap){
            pixels[Number(idx)] = 0;
        }
        drawBoard();
    }
    else if(msg.type==="clear_all"){
        pixels.fill(0);
        drawBoard();
    }
    else if(msg.type==="error"){ if(msg.session===undefined || msg.session===currentSession){ alert(msg.message); } }
};

// --- Generate verification token ---
document.getElementById("getTokenBtn").addEventListener("click", ()=>{
    ws.send(JSON.stringify({action:"get_token", session:currentSession}));
});

// --- Returning login ---
document.getElementById("returnLoginBtn").addEventListener("click", ()=>{
    const uname = document.getElementById("usernameInput").value.trim();
    const rtoken = document.getElementById("returnCodeInput").value.trim();
    if(!uname||!rtoken) return alert("Enter username and return token");
    ws.send(JSON.stringify({action:"verify", username:uname, token:rtoken, session:currentSession}));
});

// --- Admin login panel ---
document.getElementById("adminLoginBtn").addEventListener("click", () => {
    document.getElementById("adminPanel").style.display = "block";
});
document.getElementById("adminVerifyBtn").addEventListener("click", () => {
    const key = document.getElementById("adminKeyInput").value.trim();
    if(!key) return alert("Enter admin key");
    ws.send(JSON.stringify({ action:"admin", key:key, command:"check", session:currentSession }));
});
ws.addEventListener("message", e => {
    const msg = JSON.parse(e.data);
    if(msg.type === "info" && msg.message === "Admin key correct") {
        document.getElementById("adminControls").style.display = "block";
        alert("Admin verified!");
    }
    else if(msg.type === "error" && msg.message === "Invalid admin key") {
        alert("Invalid admin key!");
        document.getElementById("adminControls").style.display = "none";
    }
});
document.getElementById("clearUserPixelsBtn").addEventListener("click", () => {
    const target = document.getElementById("adminUsername").value.trim();
    if(!target) return alert("Enter username");
    ws.send(JSON.stringify({ action:"admin", key:document.getElementById("adminKeyInput").value, command:"clear_user", target }));
});
document.getElementById("unverifyUserBtn").addEventListener("click", () => {
    const target = document.getElementById("adminUsername").value.trim();
    if(!target) return alert("Enter username");
    ws.send(JSON.stringify({ action:"admin", key:document.getElementById("adminKeyInput").value, command:"unverify", target }));
});
document.getElementById("clearAllBtn").addEventListener("click", () => {
    ws.send(JSON.stringify({ action:"admin", key:document.getElementById("adminKeyInput").value, command:"clear" }));
});

// ðŸŽ¨ Init palette interactions
document.querySelectorAll("#basic-palette .color").forEach(c=>{
    c.addEventListener("click", ()=>{
        document.querySelectorAll("#basic-palette .color").forEach(x=>x.classList.remove("selected"));
        c.classList.add("selected");
        activeColor = c.dataset.color;
        console.log("Selected color:", activeColor);
    });
});
// Default select first color
document.querySelector("#basic-palette .color").classList.add("selected");

drawBoard();
</script>
</body>
</html>
