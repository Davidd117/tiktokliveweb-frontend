<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pixel Board</title>
<style>
  body { font-family: sans-serif; text-align:center; }
  #board { display:grid; grid-template-columns: repeat(20, 20px); grid-gap: 1px; margin:20px auto; }
  .cell { width:20px; height:20px; background:#eee; border:1px solid #ccc; cursor:pointer; }
  #tokenDisplay { margin:10px 0; font-weight:bold; color:blue; }
  #status { margin:10px 0; color:green; font-weight:bold; }
  button { padding:5px 10px; margin:5px; }
  input { padding:5px; margin:5px; }
</style>
</head>
<body>

<h1>Pixel Board</h1>

<div>
  <input type="text" id="username" placeholder="Enter username">
  <button id="getTokenBtn">Get Verification Token</button>
</div>
<div>
  <input type="text" id="commentToken" placeholder="Enter token from TikTok comment">
  <button id="verifyBtn">Verify</button>
</div>

<div id="tokenDisplay"></div>
<div id="status"></div>

<div id="board"></div>

<script>
const boardSize = 20; // 20x20 grid
const board = document.getElementById('board');
const tokenDisplay = document.getElementById('tokenDisplay');
const statusDisplay = document.getElementById('status');

let username = '';
let token = '';
let verified = false;
let ws;

// --- Create board cells ---
for(let i=0; i<boardSize*boardSize; i++){
  const cell = document.createElement('div');
  cell.classList.add('cell');
  cell.dataset.index = i;
  cell.addEventListener('click', () => placePixel(i));
  board.appendChild(cell);
}

// --- Connect WebSocket ---
function connectWS(){
  if(ws && ws.readyState === WebSocket.OPEN) return;

  ws = new WebSocket('ws://' + location.hostname + ':8765');
  ws.onopen = () => console.log('âœ… Connected to server');

  ws.onmessage = (msg) => {
    const data = JSON.parse(msg.data);

    if(data.type === 'token'){
      token = data.token;
      tokenDisplay.textContent = 'Your verification token: ' + token;
      statusDisplay.textContent = 'Copy this token and comment it on TikTok to verify!';
    }
    else if(data.type === 'verified'){
      if(data.user === username){
        verified = true;
        statusDisplay.textContent = 'âœ… Verified! You can place pixels now.';
      }
    }
    else if(data.type === 'error'){
      statusDisplay.textContent = 'âš  ' + data.message;
    }
    else if(data.type === 'pixel'){
      const cell = document.querySelector(`.cell[data-index='${data.index}']`);
      if(cell) cell.style.background = data.user === username ? 'green' : 'red';
    }
    else if(data.type === 'clear'){
      document.querySelectorAll('.cell').forEach(c => c.style.background='#eee');
    }
  };

  ws.onclose = () => {
    console.log('ðŸ”Œ WebSocket closed. Reconnecting in 2s...');
    setTimeout(connectWS, 2000);
  };
}

// --- Get token ---
document.getElementById('getTokenBtn').addEventListener('click', () => {
  username = document.getElementById('username').value.trim();
  if(!username) return alert('Enter username first');
  connectWS();
  ws.send(JSON.stringify({ action:'get_token', username }));
});

// --- Verify token from TikTok comment ---
document.getElementById('verifyBtn').addEventListener('click', () => {
  const enteredToken = document.getElementById('commentToken').value.trim();
  if(!username) return alert('Enter username first');
  if(!enteredToken) return alert('Enter token from TikTok comment');

  // Send comment token to server
  ws.send(JSON.stringify({ action:'verify_token', username, token:enteredToken }));
});

// --- Place pixel ---
function placePixel(index){
  if(!username) return alert('Enter username first');
  if(!verified) return alert('You need to verify first!');
  ws.send(JSON.stringify({ action:'place_pixel', username, index }));
}

</script>
</body>
</html>
