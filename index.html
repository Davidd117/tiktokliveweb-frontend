<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TikTok Live R/Place</title>
<style>
  body { background:#111; color:white; text-align:center; font-family:Arial; margin:0; padding:0; }
  #controls { padding:10px; }
  input, button { padding:5px; margin:5px; font-size:14px; }
  #canvasContainer { width: 800px; height: 800px; margin: 20px auto; border:2px solid #444; background:#222; overflow:hidden; cursor:grab; }
  canvas { width:100%; height:100%; display:block; }
  #userInfo { margin-top:10px; }
  #adminPanel { display:none; margin-top:10px; padding:10px; border:1px solid #555; background:#222; }
  #adminPanel button { margin:3px; }
</style>
</head>
<body>
<h2>TikTok Live R/Place</h2>

<div id="controls">
  <button id="getTokenBtn">Generate Verification Token</button>
  <input type="text" id="tokenInput" placeholder="Token will appear here" readonly>
  <br>
  <input type="text" id="usernameInput" placeholder="Username">
  <input type="text" id="returnCodeInput" placeholder="Token from TikTok chat">
  <button id="loginBtn">Return Login</button>
  <br>
  <button id="adminLoginBtn">Admin Login</button>
</div>

<div id="userInfo">Not verified</div>

<div id="canvasContainer">
  <canvas id="canvas"></canvas>
</div>

<div id="adminPanel">
  <h3>Admin Panel</h3>
  <input type="text" id="adminKeyInput" placeholder="Admin Key">
  <br>
  <input type="text" id="targetUserInput" placeholder="Target Username">
  <button id="unverifyUserBtn">Unverify User</button>
  <button id="clearUserPixelsBtn">Clear User Pixels</button>
  <button id="clearAllPixelsBtn">Clear All Pixels</button>
  <div id="adminStatus"></div>
</div>

<script>
const GRID_SIZE = 1000;
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
canvas.width = canvas.clientWidth;
canvas.height = canvas.clientHeight;

let currentSession = 'session_' + Math.random().toString(36).substring(2,10);
let ws = new WebSocket("wss://tiktokliveweb-production.up.railway.app");

let pixels = new Uint8Array(GRID_SIZE*GRID_SIZE);
let verified = false;
let username = null;
let pixelsLeft = 0;
let nextPixelTime = null;

// --- Zoom & Pan ---
let scale, minScale, offsetX, offsetY, dragging=false, lastX=0, lastY=0, dragMoved=false;
const dragThreshold = 5;

function resetView(){
  minScale = Math.min(canvas.width/GRID_SIZE, canvas.height/GRID_SIZE);
  scale = minScale;
  offsetX = (canvas.width - GRID_SIZE*scale)/2;
  offsetY = (canvas.height - GRID_SIZE*scale)/2;
}
resetView();

function clampOffsets(){
  const maxOffsetX = 0, maxOffsetY = 0;
  const minOffsetX = canvas.width - GRID_SIZE*scale;
  const minOffsetY = canvas.height - GRID_SIZE*scale;
  if(offsetX>maxOffsetX) offsetX=maxOffsetX;
  if(offsetY>maxOffsetY) offsetY=maxOffsetY;
  if(offsetX<minOffsetX) offsetX=minOffsetX;
  if(offsetY<minOffsetY) offsetY=minOffsetY;
}

function drawBoard(){
  ctx.setTransform(scale,0,0,scale,offsetX,offsetY);
  ctx.clearRect(-offsetX/scale,-offsetY/scale,canvas.width/scale,canvas.height/scale);
  ctx.fillStyle="#222"; ctx.fillRect(0,0,GRID_SIZE,GRID_SIZE);
  if(scale>4){
    ctx.strokeStyle="#333"; ctx.lineWidth=0.05;
    for(let x=0;x<GRID_SIZE;x++){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,GRID_SIZE);ctx.stroke();}
    for(let y=0;y<GRID_SIZE;y++){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(GRID_SIZE,y);ctx.stroke();}
  }
  for(let i=0;i<pixels.length;i++){
    if(pixels[i]){
      const x=i%GRID_SIZE, y=Math.floor(i/GRID_SIZE);
      ctx.fillStyle="#4ce0ff";
      ctx.fillRect(x,y,1,1);
    }
  }
}

canvas.addEventListener("wheel", e=>{
  e.preventDefault();
  const mouseX=(e.offsetX-offsetX)/scale;
  const mouseY=(e.offsetY-offsetY)/scale;
  const zoom=e.deltaY<0?1.1:0.9;
  scale*=zoom; scale=Math.min(Math.max(scale,minScale),40);
  offsetX=e.offsetX - mouseX*scale;
  offsetY=e.offsetY - mouseY*scale;
  clampOffsets();
  drawBoard();
});

canvas.addEventListener("mousedown", e=>{
  if(e.button===0){ lastX=e.clientX; lastY=e.clientY; dragMoved=false; dragging=false; }
});
canvas.addEventListener("mousemove", e=>{
  if(e.buttons===1){
    if(Math.abs(e.clientX-lastX)>dragThreshold || Math.abs(e.clientY-lastY)>dragThreshold) dragging=true;
    if(dragging){ offsetX += e.clientX-lastX; offsetY += e.clientY-lastY; lastX=e.clientX; lastY=e.clientY; clampOffsets(); drawBoard(); }
  }
});
canvas.addEventListener("mouseup", e=>{
  if(!dragging){
    if(!verified){ alert("You are not verified!"); return; }
    if(pixelsLeft<=0){ alert("No pixels available! Wait for cooldown."); return; }
    const x=Math.floor((e.offsetX-offsetX)/scale);
    const y=Math.floor((e.offsetY-offsetY)/scale);
    if(x>=0 && y>=0 && x<GRID_SIZE && y<GRID_SIZE){
      ws.send(JSON.stringify({action:"place_pixel", session:currentSession, index:x+y*GRID_SIZE}));
    }
  }
  dragging=false;
});

// --- WebSocket ---
ws.onopen = () => console.log("âœ… WS connected!");
ws.onmessage = e=>{
  const msg = JSON.parse(e.data);
  if(msg.type==="init_pixels"){ for(const idx in msg.pixels) pixels[idx]=1; drawBoard(); }
  else if(msg.type==="token"){ document.getElementById("tokenInput").value = msg.token; document.getElementById("userInfo").innerText = "Type this token in TikTok Live chat to verify"; }
  else if(msg.type==="verified" && msg.session===currentSession){
    verified=true; username=msg.username; pixelsLeft=msg.pixels_left??1; nextPixelTime=msg.next_pixel_time??(Date.now()/1000+5);
    document.getElementById("userInfo").innerText=`VERIFIED! Welcome back ${username}. Pixels left: ${pixelsLeft}`;
  }
  else if(msg.type==="pixel"){ pixels[msg.index]=1; if(msg.session===currentSession){ pixelsLeft=Math.max(0,pixelsLeft-1); nextPixelTime=Date.now()/1000+5; } drawBoard(); }
  else if(msg.type==="info" && msg.session===currentSession){ pixelsLeft=msg.pixels_left; nextPixelTime=msg.next_pixel_time??(Date.now()/1000+5); }
  else if(msg.type==="error"){ if(!msg.session || msg.session===currentSession) alert(msg.message); }
};

// --- Buttons ---
document.getElementById("getTokenBtn").onclick = ()=>{
  ws.send(JSON.stringify({action:"get_token", session:currentSession}));
};
document.getElementById("loginBtn").onclick = ()=>{
  const u = document.getElementById("usernameInput").value.trim();
  const code = document.getElementById("returnCodeInput").value.trim();
  if(!u || !code){ alert("Enter username and token"); return; }
  ws.send(JSON.stringify({action:"return_login", session:currentSession, username:u, return_code:code}));
};

// --- Admin Panel ---
document.getElementById("adminLoginBtn").onclick = ()=>{
  const key = prompt("Enter Admin Key:");
  if(!key) return;
  document.getElementById("adminPanel").style.display = "block";
  document.getElementById("adminKeyInput").value = key;
};

document.getElementById("unverifyUserBtn").onclick = ()=>{
  const target = document.getElementById("targetUserInput").value.trim();
  const key = document.getElementById("adminKeyInput").value.trim();
  if(!target || !key) return alert("Enter username and admin key");
  ws.send(JSON.stringify({action:"admin", key:key, command:"unverify_user", target:target}));
};
document.getElementById("clearUserPixelsBtn").onclick = ()=>{
  const target = document.getElementById("targetUserInput").value.trim();
  const key = document.getElementById("adminKeyInput").value.trim();
  if(!target || !key) return alert("Enter username and admin key");
  ws.send(JSON.stringify({action:"admin", key:key, command:"clear_user_pixels", target:target}));
};
document.getElementById("clearAllPixelsBtn").onclick = ()=>{
  const key = document.getElementById("adminKeyInput").value.trim();
  if(!key) return alert("Enter admin key");
  ws.send(JSON.stringify({action:"admin", key:key, command:"clear"}));
};

// --- Countdown ---
setInterval(()=>{
  if(!verified || !nextPixelTime) return;
  const now = Date.now()/1000;
  if(now >= nextPixelTime){ pixelsLeft++; nextPixelTime = now + 5; }
  document.getElementById("userInfo").innerText = username ? `Welcome ${username} | Pixels left: ${pixelsLeft}` : "Not verified";
},1000);

drawBoard();
</script>
</body>
</html>
