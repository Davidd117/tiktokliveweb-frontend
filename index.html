<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TikTok Live R/Place</title>
<style>
  body { background:#111; color:white; text-align:center; font-family:Arial; }
  #canvasContainer {
    width: 800px;
    height: 800px;
    margin: 20px auto;
    border: 2px solid #444;
    background: #222;
    overflow: hidden;
    cursor: grab;
  }
  canvas { width:100%; height:100%; display:block; }

  #adminPanel {
    display:none;
    position:fixed;
    top:10px; right:10px;
    background:#222; border:2px solid #4ce0ff;
    padding:10px; z-index:10;
  }
  input, button { margin:3px; }
</style>
</head>
<body>
<h2>TikTok Live R/Place</h2>
<div id="canvasContainer">
  <canvas id="canvas"></canvas>
</div>

<div id="adminPanel">
  <h3>Admin Panel</h3>
  <input type="password" id="adminKey" placeholder="Admin Key">
  <button id="connectAdmin">Connect</button>
  <div id="adminControls" style="margin-top:10px; display:none;">
    <input id="adminUsername" placeholder="Username">
    <button id="banUser">Ban</button>
    <button id="unbanUser">Unban</button>
    <button id="removeUser">Remove Verified</button>
    <button id="clearPixels">Clear Board</button>
  </div>
  <div id="adminStatus"></div>
</div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const gridSize = 1000;
const pixels = new Uint8Array(gridSize * gridSize);
canvas.width = canvas.clientWidth;
canvas.height = canvas.clientHeight;

// Camera
let scale, minScale, offsetX, offsetY;
let dragging = false, lastX, lastY;
let verified = false;  // user verification status
let username = prompt("Enter your TikTok username:");

function resetView() {
  minScale = Math.min(canvas.width / gridSize, canvas.height / gridSize);
  scale = minScale;
  offsetX = (canvas.width - gridSize*scale)/2;
  offsetY = (canvas.height - gridSize*scale)/2;
}
resetView();

function clampOffsets() {
  const maxX=0, maxY=0, minX=canvas.width-gridSize*scale, minY=canvas.height-gridSize*scale;
  offsetX=Math.min(maxX, Math.max(minX, offsetX));
  offsetY=Math.min(maxY, Math.max(minY, offsetY));
}

function drawBoard() {
  ctx.setTransform(scale,0,0,scale,offsetX,offsetY);
  ctx.clearRect(-offsetX/scale,-offsetY/scale,canvas.width/scale,canvas.height/scale);
  ctx.fillStyle="#222";
  ctx.fillRect(0,0,gridSize,gridSize);

  if(scale>4){
    ctx.strokeStyle="#333";
    ctx.lineWidth=0.05;
    for(let x=0;x<gridSize;x++){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,gridSize);ctx.stroke();}
    for(let y=0;y<gridSize;y++){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(gridSize,y);ctx.stroke();}
  }

  for(let i=0;i<pixels.length;i++){
    if(pixels[i]){
      const x=i%gridSize;
      const y=Math.floor(i/gridSize);
      ctx.fillStyle="#4ce0ff";
      ctx.fillRect(x,y,1,1);
    }
  }
}

// --- WebSocket ---
const ws = new WebSocket("wss://tiktokliveweb-production.up.railway.app"); // <- update
ws.onopen = ()=>console.log("âœ… WebSocket connected");
ws.onmessage = e=>{
  const msg=JSON.parse(e.data);
  if(msg.type==="pixel") pixels[msg.index]=1;
  if(msg.type==="verified" && msg.user===username) verified=true;
  if(msg.type==="clear") pixels.fill(0);
  drawBoard();
};

// --- Zoom ---
canvas.addEventListener("wheel",e=>{
  e.preventDefault();
  const mx=(e.offsetX-offsetX)/scale;
  const my=(e.offsetY-offsetY)/scale;
  const zoom=e.deltaY<0?1.1:0.9;
  scale*=zoom;
  scale=Math.min(Math.max(scale,minScale),40);
  offsetX=e.offsetX-mx*scale;
  offsetY=e.offsetY-my*scale;
  clampOffsets();
  drawBoard();
});

// --- Pan ---
canvas.addEventListener("mousedown",e=>{if(e.button===1){dragging=true;lastX=e.clientX;lastY=e.clientY;canvas.style.cursor="grabbing";e.preventDefault();}});
canvas.addEventListener("mousemove",e=>{if(dragging){offsetX+=e.clientX-lastX;offsetY+=e.clientY-lastY;lastX=e.clientX;lastY=e.clientY;clampOffsets();drawBoard();}});
canvas.addEventListener("mouseup",e=>{if(e.button===1){dragging=false;canvas.style.cursor="grab";}});

// --- Place pixel ---
canvas.addEventListener("click",e=>{
  if(e.button!==0) return;
  if(!verified){alert("You must be verified to place pixels!"); return;}
  const x=Math.floor((e.offsetX-offsetX)/scale);
  const y=Math.floor((e.offsetY-offsetY)/scale);
  if(x>=0&&y>=0&&x<gridSize&&y<gridSize){
    const index=y*gridSize+x;
    ws.send(JSON.stringify({action:"place_pixel",username:index, index:index}));
  }
});

drawBoard();

// --- Admin Panel ---
const panel=document.getElementById("adminPanel");
const controls=document.getElementById("adminControls");
const status=document.getElementById("adminStatus");
document.getElementById("connectAdmin").onclick=()=>{
  const key=document.getElementById("adminKey").value;
  ws.send(JSON.stringify({action:"admin",key:key,command:"check"}));
  // We'll handle response from server to show controls
  ws.onmessage=e=>{
    const msg=JSON.parse(e.data);
    if(msg.type==="admin_ok"){controls.style.display="block";status.textContent=msg.message;}
    if(msg.type==="error"){status.textContent=msg.message;}
  }
};
document.getElementById("banUser").onclick=()=>ws.send(JSON.stringify({action:"admin",key:document.getElementById("adminKey").value,command:"ban",username:document.getElementById("adminUsername").value}));
document.getElementById("unbanUser").onclick=()=>ws.send(JSON.stringify({action:"admin",key:document.getElementById("adminKey").value,command:"unban",username:document.getElementById("adminUsername").value}));
document.getElementById("removeUser").onclick=()=>ws.send(JSON.stringify({action:"admin",key:document.getElementById("adminKey").value,command:"remove_user",username:document.getElementById("adminUsername").value}));
document.getElementById("clearPixels").onclick=()=>ws.send(JSON.stringify({action:"admin",key:document.getElementById("adminKey").value,command:"clear_pixels"}));
</script>
</body>
</html>

